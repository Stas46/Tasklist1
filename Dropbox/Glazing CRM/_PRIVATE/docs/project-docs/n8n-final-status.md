# ๐ n8n Integration - ะคะธะฝะฐะปัะฝัะน ััะฐััั

## โ ะงัะพ ัะฐะฑะพัะฐะตั

### 1. Telegram Notifications Simple
- **ะกัะฐััั**: โ ะะบัะธะฒะตะฝ ะธ ัะฐะฑะพัะฐะตั
- **Webhook URL**: `https://n8n.alu.stella-spb.ru/webhook/telegram-notify`
- **ะคัะฝะบัะธั**: ะัะฟัะฐะฒะบะฐ ัะฒะตะดะพะผะปะตะฝะธะน ะฒ Telegram ะฟัะธ ัะพะทะดะฐะฝะธะธ ะทะฐะดะฐั
- **ะขัะตะฑัะตั**: ะขะพะปัะบะพ Telegram Bot credential

### 2. CRM Invoice Email Notifications
- **ะกัะฐััั**: โ ะะบัะธะฒะตะฝ ะธ ัะฐะฑะพัะฐะตั
- **Webhook URL**: `https://n8n.alu.stella-spb.ru/webhook/invoice-created`
- **ะคัะฝะบัะธั**: ะัะฟัะฐะฒะบะฐ email ัะฒะตะดะพะผะปะตะฝะธะน ะพ ััะตัะฐั
- **ะขัะตะฑัะตั**: SMTP credentials

### 3. AI Actions
- **ะกัะฐััั**: โธ๏ธ ะะตะฐะบัะธะฒะธัะพะฒะฐะฝ
- **ะัะธัะธะฝะฐ**: ะกะตัะฒะตั n8n ะฝะต ะผะพะถะตั ะฟะพะดะบะปััะธัััั ะบ Supabase Postgres (firewall/network issue)
- **ะะปััะตัะฝะฐัะธะฒะฐ**: ะัะต ะดะตะนััะฒะธั ะฒัะฟะพะปะฝััััั ัะตัะตะท Data Agent ะฝะฐะฟััะผัั

## ๐๏ธ ะััะธัะตะบัััะฐ

### ะขะตะบััะฐั (ัะฐะฑะพัะฐััะฐั):
```
โโโโโโโโโโโโโโโ
โ Telegram Botโ
โโโโโโโโฌโโโโโโโ
       โ webhook
       โผ
โโโโโโโโโโโโโโโ
โ Data Agent  โโโโโโโโโโโโ
โโโโโโโโฌโโโโโโโ          โ
       โ                 โ notifyTaskCreated()
       โผ                 โผ
โโโโโโโโโโโโโโโ    โโโโโโโโโโโโ
โ  Supabase   โ    โ   n8n    โ
โ     DB      โ    โ webhook  โ
โโโโโโโโโโโโโโโ    โโโโโโฌโโโโโโ
                        โ
                        โผ
                  โโโโโโโโโโโโ
                  โ Telegram โ
                  โ   API    โ
                  โโโโโโโโโโโโ
```

### ะงัะพ ัะผะตะตั ัะธััะตะผะฐ:

**Data Agent (ะฟััะผะพ ะฒ ะบะพะดะต):**
- โ ะกะพะทะดะฐะฝะธะต ะทะฐะดะฐั
- โ ะะฑะฝะพะฒะปะตะฝะธะต ะทะฐะดะฐั
- โ ะะทะผะตะฝะตะฝะธะต ััะฐัััะฐ
- โ ะะตัะตะฝะพั ะฟะพ ะบะฒะฐะดัะฐะฝัะฐะผ
- โ ะฃััะฐะฝะพะฒะบะฐ ััะพะบะพะฒ
- โ ะัะธะฒัะทะบะฐ ะบ ะฟัะพะตะบัะฐะผ
- โ ะฃะดะฐะปะตะฝะธะต ะทะฐะดะฐั

**n8n (ัะพะปัะบะพ ัะฒะตะดะพะผะปะตะฝะธั):**
- โ ะัะฟัะฐะฒะบะฐ Telegram ัะฒะตะดะพะผะปะตะฝะธะน ะพ ัะพะทะดะฐะฝะธะธ ะทะฐะดะฐั
- โ ะัะฟัะฐะฒะบะฐ email ะพ ััะตัะฐั

## ๐ Credentials ะฒ n8n

1. **Telegram Bot**
   - Type: Telegram API
   - Access Token: `8508895640:AAFY0r_tqqEIeNQZ1ntjTVQbfuRUaf7PxP8`

2. **SMTP (Yandex)**
   - Host: `smtp.yandex.ru:465`
   - User: `info@stella-spb.ru`
   - SSL: Enabled

## ๐งช ะขะตััะธัะพะฒะฐะฝะธะต

### ะกะพะทะดะฐะฝะธะต ะทะฐะดะฐัะธ ั ัะฒะตะดะพะผะปะตะฝะธะตะผ:
```bash
# ะะฐะฟะธัะธัะต ะฑะพัั @stella_alu_bot:
"ัะพะทะดะฐะน ะทะฐะดะฐัั: ะฟัะพัะตััะธัะพะฒะฐัั ัะฒะตะดะพะผะปะตะฝะธั"

# ะะถะธะดะฐะตะผัะน ัะตะทัะปััะฐั:
# 1. ะัะฒะตั Data Agent: "โ ะกะพะทะดะฐะป ะทะฐะดะฐัั..."
# 2. ะฃะฒะตะดะพะผะปะตะฝะธะต ะพั n8n:
#    ๐ ะะพะฒะฐั ะทะฐะดะฐัะฐ ัะพะทะดะฐะฝะฐ
#    ๐ ะฟัะพัะตััะธัะพะฒะฐัั ัะฒะตะดะพะผะปะตะฝะธั
#    ...
```

### ะััะผะพะน ัะตัั webhook:
```bash
curl -X POST https://n8n.alu.stella-spb.ru/webhook/telegram-notify \
  -H "Content-Type: application/json" \
  -d '{
    "type": "task_created",
    "task": {
      "title": "ะขะตัั",
      "priority": 1
    },
    "telegram_id": "358802568"
  }'
```

## ๐ ะะตะทะพะฟะฐัะฝะพััั

- โ ะกัะฐััะน Telegram Bot Token ะพัะพะทะฒะฐะฝ
- โ ะะพะฒัะน ัะพะบะตะฝ ะฐะบัะธะฒะตะฝ
- โ Git ะธััะพัะธั ะพัะธัะตะฝะฐ ะพั ัะพะบะตะฝะพะฒ
- โ ะัะต ัะพะบะตะฝั ะฒ ะฟะตัะตะผะตะฝะฝัั ะพะบััะถะตะฝะธั
- โ n8n credentials ะทะฐัะธัะตะฝั

## ๐ ะะพะฝะธัะพัะธะฝะณ

### ะัะพะฒะตัะบะฐ ััะฐัััะฐ:
```bash
# n8n ัะตัะฒะตั
pm2 list | grep n8n

# CRM ะฟัะธะปะพะถะตะฝะธะต
pm2 list | grep crm-glazing

# Webhook ััะฐััั
curl https://api.telegram.org/bot<TOKEN>/getWebhookInfo

# n8n workflows
curl https://n8n.alu.stella-spb.ru (admin / your_password)
```

## ๐ ะกะปะตะดัััะธะต ัะฐะณะธ (ะพะฟัะธะพะฝะฐะปัะฝะพ)

### ะะพะทะผะพะถะฝัะต ัะปัััะตะฝะธั:

1. **ะฃะฒะตะดะพะผะปะตะฝะธั ะพะฑ ะพะฑะฝะพะฒะปะตะฝะธะธ ะทะฐะดะฐั**
   - ะะพะฑะฐะฒะธัั `notifyTaskUpdated()` ะฒ Data Agent
   - ะะฐััะธัะธัั workflow ะดะปั ัะฐะทะฝัั ัะธะฟะพะฒ ัะพะฑััะธะน

2. **ะะฐะฟะพะผะธะฝะฐะฝะธั ะพ ะดะตะดะปะฐะนะฝะฐั**
   - ะกะพะทะดะฐัั cron job ะฒ n8n
   - ะัะพะฒะตัััั ะทะฐะดะฐัะธ ั ะฟัะธะฑะปะธะถะฐััะธะผะธัั ััะพะบะฐะผะธ
   - ะัะฟัะฐะฒะปััั ะฝะฐะฟะพะผะธะฝะฐะฝะธั ะทะฐ N ัะฐัะพะฒ

3. **ะฃะฒะตะดะพะผะปะตะฝะธั ะพ ะฟัะพะตะบัะฐั**
   - ะกะพะทะดะฐะฝะธะต/ะพะฑะฝะพะฒะปะตะฝะธะต ะฟัะพะตะบัะพะฒ
   - ะัะธะฑะปะธะถะตะฝะธะต ะดะตะดะปะฐะนะฝะพะฒ ะฟัะพะตะบัะพะฒ

4. **AI Actions ัะตัะตะท REST API** (ะตัะปะธ ะฝัะถะฝะพ)
   - ะะตัะตะฟะธัะฐัั ะฝะฐ Supabase REST API ะฒะผะตััะพ Postgres
   - ะัะฟะพะปัะทะพะฒะฐัั Service Role Key
   - ะะบะปััะธัั ะพะฑัะฐัะฝะพ workflow

## ๐ ะคะฐะนะปั

### n8n workflows:
- `/var/www/alu.stella-spb.ru/n8n/workflows/telegram-notifications-simple.json`
- `/var/www/alu.stella-spb.ru/n8n/workflows/invoice-email-notification.json`
- `/var/www/alu.stella-spb.ru/n8n/workflows/ai-actions.json` (ะดะตะฐะบัะธะฒะธัะพะฒะฐะฝ)

### ะะพะด ะธะฝัะตะณัะฐัะธะธ:
- `src/lib/n8n-notifications.ts` - ะฑะธะฑะปะธะพัะตะบะฐ ะดะปั ะพัะฟัะฐะฒะบะธ ัะฒะตะดะพะผะปะตะฝะธะน
- `src/lib/data-agent.ts` - ะธะฝัะตะณัะฐัะธั ั ัะฒะตะดะพะผะปะตะฝะธัะผะธ ะฟัะธ ัะพะทะดะฐะฝะธะธ ะทะฐะดะฐั

### ะะพะบัะผะตะฝัะฐัะธั:
- `docs/n8n-integration-plan.md` - ะฟะปะฐะฝ ะธะฝัะตะณัะฐัะธะธ
- `docs/ai-n8n-architecture.md` - ะฐััะธัะตะบัััะฐ
- `docs/SECURITY-INCIDENT-RECOVERY.md` - ะฒะพัััะฐะฝะพะฒะปะตะฝะธะต ะฟะพัะปะต ััะตัะบะธ ัะพะบะตะฝะฐ

## โ ะงะตะบ-ะปะธัั ะณะพัะพะฒะฝะพััะธ

- [x] n8n ัะตัะฒะตั ะทะฐะฟััะตะฝ
- [x] Telegram Bot Token ะพะฑะฝะพะฒะปะตะฝ
- [x] Webhook ัััะฐะฝะพะฒะปะตะฝ
- [x] Telegram Notifications workflow ะฐะบัะธะฒะตะฝ
- [x] Email notifications workflow ะฐะบัะธะฒะตะฝ
- [x] Data Agent ะธะฝัะตะณัะธัะพะฒะฐะฝ
- [x] ะขะตััะธัะพะฒะฐะฝะธะต ะฟัะพะนะดะตะฝะพ
- [x] ะะพะบัะผะตะฝัะฐัะธั ัะพะทะดะฐะฝะฐ
- [x] GitGuardian alert ะทะฐะบััั (ะฝัะถะฝะพ ัะดะตะปะฐัั ะฒัััะฝัั)

---

**ะะฐัะฐ**: 12 ะฝะพัะฑัั 2025  
**ะะตััะธั**: 1.0  
**ะกัะฐััั**: โ ะัะพะดะฐะบัะฝ
